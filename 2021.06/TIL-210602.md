**[210602]**



## ìˆ˜ì—… ì •ë¦¬ - ìŠ¤í† ì–´ë“œ í”„ë¡œì‹œì € stored procedure

ëª¨ë¥´ë©´ ì´ìƒí•˜ì§€ë§Œ êµ³ì´ ê³µë¶€í•  í•„ìš”ëŠ” ì—†ëŠ”..?.. í•˜ì§€ë§Œ ì¤‘ìš”í•œ..!!..



sql ëª…ë ¹ì€ ê¸°ë³¸ì ìœ¼ë¡œ **ì„ ì–¸ì (declarative) (what) ëª…ë ¹**ì´ë‹¤.

DBì—ì„œ **'ì ˆì°¨ì  ëª…ë ¹(imperative) (how)'**ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ìŠ¤í† ì–´ë“œ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.



### ìŠ¤í† ì–´ë“œ í”„ë¡œê·¸ë¨ 

- DBì— ì €ì¥ëœ í”„ë¡œê·¸ë¨
- í•œ ë§ˆë””ë¡œ DBì— í”„ë¡œê·¸ë¨ì„ ì €ì¥í•´ ì‚¬ìš©í•˜ëŠ” ê²ƒ

ìŠ¤í† ì–´ë“œ í”„ë¡œì‹œì €ëŠ” DBì— ì €ì¥ë˜ê¸° ë•Œë¬¸ì— MySQL ì¢…ë£Œ í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ë„ ë‚¨ì•„ ìˆë‹¤.

### ìŠ¤í† ì–´ë“œ í”„ë¡œê·¸ë¨ì˜ ì¢…ë¥˜

- ìŠ¤í† ì–´ë“œ í•¨ìˆ˜
- ìŠ¤í† ì–´ë“œ í”„ë¡œì‹œì ¸
- íŠ¸ë¦¬ê±°
- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬

### ìŠ¤í† ì–´ë“œ í”„ë¡œê·¸ë¨ì˜ ì¥ì 

- ì‘ìš©í”„ë¡œê·¸ë¨ì˜ ì„±ëŠ¥ í–¥ìƒ
- **ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ê°ì†Œ**
  - ì—¬ëŸ¬ ë²ˆ ì¿¼ë¦¬ ë‚ ë ¤ì•¼ í•˜ëŠ” ê±¸ í•œ ë²ˆìœ¼ë¡œ ì¤„ì¼ ìˆ˜ ìˆìŒ
  - DBì—ì„œ ìµœì¢… ê²°ê³¼ë¬¼ê¹Œì§€ ë§Œë“¤ì–´ ê·¸ê²ƒë§Œ ë³´ë‚´ì£¼ê¸° ë•Œë¬¸
- ë³´ì•ˆì„± í–¥ìƒ
- ê°œë°œ ì—…ë¬´ì˜ êµ¬ë¶„ - ìŠ¤í† ì–´ë“œ í”„ë¡œê·¸ë¨ì€ DBAê°€ ì§ ë‹¤

### ìŠ¤í† ì–´ë“œ í”„ë¡œê·¸ë¨ì˜ ë‹¨ì 

- ìœ ì§€ë³´ìˆ˜ê°€ ë§¤ìš° ì–´ë µë‹¤
  - ì½”ë“œê°€ DBì— ë“¤ì–´ìˆê¸° ë•Œë¬¸
  - ë¬¸ì œê°€ ìƒê²¼ì„ ë•Œ rollbackì„ í•˜ê¸° ì–´ë µë‹¤
- gitì—ì„œ ê´€ë¦¬ê°€ ì‰½ì§€ì•Šë‹¤
  - DBAê°€ ê¹ƒì„ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë–„ë¬¸
- ëª…ë ¹ ìì²´ì˜ ì„±ëŠ¥ ê°ì†Œ (ìë°”ë³´ë‹¤ ëŠë¦¼)

### ìŠ¤í† ì–´ë“œ í”„ë¡œê·¸ë¨ ì‚¬ìš©í•˜ëŠ” ê³³

- ê²Œì„ ë¶„ì•¼ì—ì„œ ë§ì´ ì‚¬ìš©.
- ì›¹ë¶„ì•¼ëŠ” ì¼€ë°”ì¼€ì§€ë§Œ ì‚¬ìš©ìœ¨ ê°ì†Œ ì¤‘

### stored function vs stored procedure

í•¨ìˆ˜ëŠ” ì¿¼ë¦¬ ë‚´ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŒ. ëŒ€ì‹  ì œì•½ì‚¬í•­ì´ ë§ìŒ.

í”„ë¡œì‹œì ¸ëŠ” ì¿¼ë¦¬ ë‚´ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ

ìš°ë¦¬ëŠ” í”„ë¡œì‹œì €ë§Œ ë‹¤ë£¬ë‹¤.

### Hello World ì°ê¸°

```
DROP PROCEDURE IF EXISTS SP_HELLO;
DELIMITER $$
CREATE PROCEDURE SP_HELLO()
	BEGIN
		DECLARE STR CHAR(20) DEFAULT 'POPI';
		SET STR = 'HELLO, WORLD';
		SELECT STR;
        END $$
DELIMITER ;

CALL SP_HELLO();
```

- `SP_...` : ê´€í–‰. ìŠ¤í† ì–´ë“œ í”„ë¡œì‹œì € ì´ë¦„ ì•ì— ë¶™ì„

- `DELIMITER $$` : êµ¬ë¶„ì. êµ¬ë¬¸ ëë‚´ëŠ” ë¬¸ì¥ì„ ì‚¬ìš©ìê°€ ì§€ì •í•  ìˆ˜ ìˆìŒ. (`;`ëŒ€ì‹ )
  - `END $$`ê¹Œì§€ `$$`ë¥¼ ë¸ë¦¬ë¯¸í„°ë¡œ ì‚¬ìš©í•¨
- `DECLARE STR` : STRì´ë¼ëŠ” ì´ë¦„ì˜ ë³€ìˆ˜ë¥¼ ì„ ì–¸í•¨. 
  - DBì—ì„œëŠ” ë¬¸ìì—´ì„ ìŒë”°ì˜´í‘œê°€ ì•„ë‹Œ í™‘ë”°ì˜´í‘œ`'`ë¡œ ê°ì‹¸ì•¼ í•œë‹¤!

### ê¸°ë³¸ ë³€ìˆ˜ ì‚¬ìš©í•˜ê¸°

ê¸°ë³¸ ë³€ìˆ˜ ì„ ì–¸ : `DECLARE ë³€ìˆ˜ëª… íƒ€ì… [DEFAULT ê¸°ë³¸ê°’]`

(`[]`ë‚´ì˜ ê°’ì€ ì˜µì…˜ì´ë‹¤)

- ê¸°ë³¸ ë³€ìˆ˜ëŠ” í”„ë¡œì‹œì ¸ ë‚´ì—ì„œë§Œ ìœ íš¨í•¨!

### ì„¸ì…˜ ë³€ìˆ˜ ì„ ì–¸ ë° ì‚¬ìš©

`SET @ë³€ìˆ˜ëª… = ê°’;`

- ì„¸ì…˜ ë³€ìˆ˜ëŠ” ë§ ê·¸ëŒ€ë¡œ ì„¸ì…˜ ë‚´ì—ì„œ ê³„ì† ìœ íš¨í•¨.

- `SET @VAR_TEST = 10;`

- `SELECT @VAR_TEST;`

### ê¸°ë³¸ ë³€ìˆ˜ì— ê°’ ë„£ê¸°

SET ì‚¬ìš©

`SET A = 10;`

```
DROP PROCEDURE IF EXISTS SP_TEST1;
DELIMITER $$
CREATE PROCEDURE SP_TEST1()
	BEGIN
		DECLARE A INT;
		SET A = 10;
		SET A = A * 2;
		SELECT A;
    END $$
DELIMITER ;

CALL SP_TEST1();
```

### SELECT INTO ì‚¬ìš©

ì¿¼ë¦¬ì˜ ê²°ê³¼ë¥¼ ë³€ìˆ˜ì— ë„£ì„ ìˆ˜ ìˆìŒ.

**ë‹¨, ì¿¼ë¦¬ì˜ ê²°ê³¼ê°’ì´ ìŠ¤ì¹¼ë¼ ê°’ì´ ê²½ìš°ë§Œ ê°€ëŠ¥**

>  DBì—ì„œ ìŠ¤ì¹¼ë¼ = ë‹¨ì¼ê°’ì„ ëœ»í•¨. (í…Œì´ë¸” ì—´ í•˜ë‚˜ê°€ ì•„ë‹Œ, 'ê°’' í•˜ë‚˜)

```
DROP PROCEDURE IF EXISTS SP_TEST2;
DELIMITER $$
CREATE PROCEDURE SP_TEST2()
	BEGIN
		DECLARE A ING;
		SELECT COUNT(UID) INTO A FROM USER_INFO;
		SELECT A;
	END $$
DELIMITER ;

CALL SP_TEST2();
```

### ê²°ê³¼ê°’ì„ í…Œì´ë¸”ì— ë„£ê¸°

```
CREATE TABLE TEST3(NUM INT);
INSERT INTO TEST3 VALUES (1);
DROP PROCEDURE IF EXISTS SP_TEST3;
DELIMITER $$
CREATE PROCEDURE SP_TEST3()
	BEGIN
		DECLARE A INT DEFAULT 1;
		SELECT MAX(NUM) INTO A FROM TEST3;
		SET A = A + 1;
		INSERT INTO TEST3 VALUES(A);
		SELECT * FROM TEST3;
    END $$
DELIMITER ;

CALL SP_TEST3();
CALL SP_TEST3();
CALL SP_TEST3();
SELECT * FROM TEST3;
```

TEST3 í…Œì´ë¸”ì—ëŠ” 1,2,3,4,5ê°€ ë“¤ì–´ê°€ê²Œ ëœë‹¤.

### ë§¤ê°œë³€ìˆ˜ ì‚¬ìš©í•˜ê¸° (IN, OUT)

- `IN ë§¤ê°œë³€ìˆ˜ëª…` .
  
  - ì…ë ¥ì— ì‚¬ìš©
  
  - ```
    DROP TABLE IF EXISTS TEST4;
    CREATE TABLE TEST4 (
    	ID INT PRIMARY KEY AUTO_INCREMENT,
    	NAME VARCHAR(20)
    );
    INSERT INTO TEST4 VALUES (NULL, 'AA');
    INSERT INTO TEST4 VALUES (NULL, 'BB');
    INSERT INTO TEST4 VALUES (NULL, 'CC');
    INSERT INTO TEST4 VALUES (NULL, 'DD');
    
    DROP PROCEDURE IF EXISTS SP_TEST4;
    DELIMITER $$
    CREATE PROCEDURE SP_TEST4(IN pname varchar(10) )
    	BEGIN
    		DECLARE A INT DEFAULT 1;
    		SELECT * FROM TEST4 WHERE NAME = pname;
        END $$
    DELIMITER ;
    
    CALL SP_TEST4('DD');
    ```
  
  - ê²°ê³¼ë¡œ IDê°€ 4, NAMEì´ `DD`ì¸ ë°ì´í„°ê°€ ì¡°íšŒëœë‹¤.
  
- `OUT ë§¤ê°œë³€ìˆ˜ëª…`
  
  - ì¶œë ¥ì— ì‚¬ìš© 
  
  - (ìë°”ì˜ `return`ê³¼ ë¹„ìŠ·í•œ ìš©ë„)
  
  - ```
    DROP PROCEDURE IF EXISTS SP_TEST5;
    DELIMITER $$
    CREATE PROCEDURE SP_TEST5(IN pname varchar(10),
    	OUT pid int)
    	BEGIN
    		DECLARE A INT DEFAULT 1;
    		SELECT id into pid
    			FROM TEST4
    			WHERE NAME = pname;
    	END $$
    DELIMITER ;
    
    CALL SP_TEST5('DD', @var_ret);
    SELECT @VAR_RET;
    ```
- `INOUT ë§¤ê°œë³€ìˆ˜ëª…`
  - ì…ë ¥, ì¶œë ¥ì— ë™ì‹œì— ì‚¬ìš©í•  ë³€ìˆ˜

### IF ì‚¬ìš©í•˜ê¸°

`END IF;`ë¡œ ëë‚œë‹¤ëŠ” ì ì„ ì£¼ì˜í•´ì•¼.

```
IF if_expression THEN commands
	[ELSEIF elseif_expression THEN commands]
	[ELSE commands]
	END IF;
```

```
DROP TABLE IF EXISTS TEST6;
CREATE TABLE TEST6(NUM INT);

DROP PROCEDURE IF EXISTS SP_TEST6;
DELIMITER $$
CREATE PROCEDURE SP_TEST6(OUT RET INT)
	BEGIN
		DECLARE A INT DEFAULT 1;
		SELECT MAX(NUM) INTO A FROM TEST6;
		IF A IS NULL THEN
			SET A = 1;
		ELSE
			SET A = A + 1;
		END IF;
		INSERT INTO TEST6 VALUES (A);
		SET RET = A;
	END $$
DELIMITER ;

CALL SP_TEST6(@i);
SELECT @i;

CALL SP_TEST6(@i);
SELECT @i;

CALL SP_TEST6(@i);
SELECT @i;

```

`@i`ì˜ ìµœì¢… ê²°ê³¼ê°’ : `3`

>  DBì—ì„œì˜ NULLì€ 'ê°’ì„ ì˜ ëª¨ë¥´ê² ë‹¤'ëŠ” ì˜ë¯¸ì— ê°€ê¹ë‹¤.
>
> `NULL + 1 = NULL`

### WHILE ì‚¬ìš©í•˜ê¸°

ì—­ì‹œ `END WHILE;`ë¡œ ëë‚œë‹¤ëŠ” ê²ƒì„ ì¡°ì‹¬í•´ì•¼.

```
WHILE expression DO
	Statements
END WHILE
```

### ê¸°íƒ€

ì´ ì™¸ì— CASE (switch caseì™€ ê°™ì€ ìš©ë„), REPEAT_UNTIL(do whileê³¼ ê°™ì€ ìš©ë„)ë„ ìˆë‹¤.

### ì‹¤ìŠµ1 - DBë¡œ ë³„ ì°ê¸°

```
DROP TABLE IF EXISTS STAR;
CREATE TABLE STAR (LNO INT, LINE VARCHAR(64));

DROP PROCEDURE IF EXISTS SP_STAR;
DELIMITER $$
CREATE PROCEDURE SP_STAR(IN LNO INT)
	BEGIN
		DECLARE S VARCHAR(64) DEFAULT '*';
		DECLARE I INT DEFAULT 1;
		
		DELETE FROM STAR WHERE LNO >= 1;
		
		WHILE I <= LNO DO // WHILEë¬¸
			INSERT INTO STAR VALUES(I, S);
            SET S = CONCAT(S, '*');
            SET I = I + 1;
        END WHILE;
        SELECT * FROM STAR;
    END $$
DELIMITER ;
```

- `CONCAT(a, b);` : ë‚´ì¥í•¨ìˆ˜. ë‘ ë¬¸ìì—´ì„ í•©ì¹˜ëŠ” í•¨ìˆ˜

- â—`DECLARE`ê°€ ìˆë‹¤ë©´ ë°˜ë“œì‹œ ê·¸ êµ¬ë¬¸ì˜ ë§¨ ìœ„ì— ìˆì–´ì•¼ í•œë‹¤.



---



##  ìŠ¤í¬ë¦½íŠ¸ì™€ S3 bucketì„ ì´ìš©í•œ ìŠ¤í”„ë§ ì•± ë°°í¬ ìë™í™”(+ ìŠ¬ë™ ë´‡, crontab í™œìš©)

>  yeonì´ ì˜¤ëŠ˜ í”„ë¡œì íŠ¸ì—ì„œ ê°€ë¥´ì³ ì£¼ì‹  ë°°í¬ìë™í™” ê³¼ì •ì„ ì •ë¦¬í•´ ë³´ì•˜ë‹¤! ğŸ™‡â€â™‚ï¸
>
> (ì¶œì²˜ : [S3 bucketì„ ì´ìš©í•œ ë°°í¬ ìë™í™”](https://velog.io/@yeon/S3-bucket%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B0%B0%ED%8F%AC-%EC%9E%90%EB%8F%99%ED%99%94))



ë‹¤ìŒê³¼ ê°™ì€ ìë™í™”ë¥¼ í•˜ê²Œ ëœë‹¤.

- ë¡œì»¬ì—ì„œ ë¹Œë“œí•œ ìŠ¤í”„ë§ ì•±ì˜ ë¹Œë“œ íŒŒì¼(jar)ì„ S3ì— ë„£ê¸°

- ì¸ìŠ¤í„´ìŠ¤ê°€ s3ë¥¼ 1ë¶„ë§ˆë‹¤ ì²´í¬

- ë¹Œë“œ íŒŒì¼ì´ ìƒˆë¡œìš´ ë²„ì „ì´ë©´ s3ì—ì„œ ë¹Œë“œ ë° ë°°í¬



[ì¤€ë¹„ë¬¼] ì˜ ëŒì•„ê°€ëŠ” ìŠ¤í”„ë§ ì•±, aws ê³„ì •ê³¼ ec2 ì¸ìŠ¤í„´ìŠ¤, ìŠ¬ë™

1. (ë¡œì»¬) ìŠ¤í”„ë§ ì•±ì„ ë¹Œë“œí•´ jaríŒŒì¼ì„ ìƒì„±í•¨

   - í”„ë¡œì íŠ¸ í´ë”ì—ì„œ `./gradlew build jar`

2. (ec2) S3ì—ì„œ ë°°í¬ìš© bucket ìƒì„±

   - awsì„œë¹„ìŠ¤ ì¤‘ s3 ì„ íƒ -  ë²„í‚· - ë²„í‚· ë§Œë“¤ê¸°
   - ë²„í‚· ìƒì„±ì‹œ ì´ë¦„ì´ ë‹¤ë¥¸ ë²„í‚·ê³¼ ì¤‘ë³µë˜ë©´ ì•ˆ ë¨
   - ê¸°ë³¸ì˜µì…˜ ê·¸ëŒ€ë¡œ ë§Œë“¤ê¸°

3. (ë¡œì»¬) aws cli ì„¤ì¹˜

   - aws ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì„¤ì¹˜í•¨.
   - https://velog.io/@trycatch/AWS-CLI-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0ë¥¼ ì°¸ê³ í•´ ì„¤ì¹˜í•œ ë‹¤ìŒ,
   - https://lovemewithoutall.github.io/it/aws-cli-configure/ ë¥¼ ì°¸ê³ í•´ ì´ˆê¸° ì„¤ì •ì„ ë§ˆì¹˜ê¸°. (IAMì„ ë§Œë“¤ ë•Œ ìƒì„±ë˜ëŠ” AWS Access Key ID, AWS Secret Access Key í•„ìš”)

4. (ë¡œì»¬ -> ec2) jaríŒŒì¼ì„ S3 ë²„í‚·ìœ¼ë¡œ ë³µì‚¬

   - jaríŒŒì¼ì´ ìˆëŠ” ìœ„ì¹˜ë¡œ ì´ë™(ë³´í†µ í”„ë¡œì íŠ¸ íŒŒì¼ì—ì„œ `cd /build/libs`)
   - `aws s3 cp jaríŒŒì¼ëª… s3://ë²„í‚·ì´ë¦„/íŒŒì¼ì´ë¦„`
   - *`íŒŒì¼ì´ë¦„`ì˜ ê²½ìš°, ë³µì‚¬ë¥¼ í†µí•´ ìƒˆë¡œ ìƒì„±ë˜ëŠ” íŒŒì¼ ì´ë¦„ì„ ëœ»í•¨. ì§ì ‘ ì§€ì •í•´ ì£¼ë©´ ëœë‹¤.
   - `aws s3 ls s3://ë²„í‚·ì´ë¦„` ìœ¼ë¡œ s3ë²„í‚·ì— ì˜ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

5. (ec2 - Role) s3 access ì •ì±…ì´ ì—°ê²°ëœ Role(ì—­í• ) ì¶”ê°€ ë° ec2 ì¸ìŠ¤í„´ìŠ¤ì— ë“±ë¡

   - ec2 ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì† í›„, 3.ì˜ ë°©ë²•ì„ ì°¸ê³ í•´ aws clië¥¼ ë™ì¼í•˜ê²Œ ì„¤ì¹˜ (`sudo apt install awscli`)
   - ì´ì œ s3ì— ì ‘ê·¼í•˜ëŠ” ì£¼ì²´ì¸ ec2ê°€ s3ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•´ ì£¼ì–´ì•¼ í•œë‹¤. = aws Role
   - awsì„œë¹„ìŠ¤ ì¤‘ IAMì„ ì„ íƒ - ì—­í• (role) - ì—­í•  ë§Œë“¤ê¸°.
   - ë§Œë“  ì—­í• ì— `AmazonS3FulAccess`ë¼ëŠ” ì •ì±… ì—°ê²°
   - ì—­í•  ìƒì„± í›„, ë‹¤ì‹œ ec2 ì¸ìŠ¤í„´ìŠ¤ë¡œ ëŒì•„ê¸°
   - ì¸ìŠ¤í„´ìŠ¤ì— ì²´í¬ë°•ìŠ¤ ì²´í¬ í›„ [ì‘ì—…] - [ë³´ì•ˆ] - [IAM ì—­í•  ìˆ˜ì •] - 'IAMì—­í• 'ì—ì„œ ë°©ê¸ˆ ìƒì„±í•œ ì—­í•  ì„ íƒ í›„ ì €ì¥
   - ì´ì œ í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ëŠ” S3ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ë¨.
   - í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ `aws s3 ls`ë¥¼ ì…ë ¥í•´ ì˜ ì¡°íšŒë˜ëŠ”ì§€ í™•ì¸.

6. (ë¡œì»¬) ìŠ¬ë™ web hook ì„¤ì •í•˜ê¸°

   - ë°°í¬ ìë™í™”ë¥¼ í†µí•´ ë°°í¬ê°€ ì´ë£¨ì–´ì§ˆ ë•Œ, ìŠ¬ë™ íŠ¹ì • ì±„ë„ì— ë´‡ì„ í†µí•´ ì•Œë¦¼ì´ ì „ì†¡ë˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.
   - https://jojoldu.tistory.com/552 ë¥¼ ì°¸ê³ í•´ ì•Œë¦¼ì„ ë°›ì„ ìŠ¬ë™ ì±„ë„ì— webhook ì•±ì„ ì¶”ê°€í•˜ê³ , `WebhookURLì£¼ì†Œ`ë¥¼ ë°›ì•„ ë‘”ë‹¤.

7. (ec2) ë°°í¬ ìë™í™” - ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

   - ec2 ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•´ `build.sh`ë¼ëŠ” ì´ë¦„ì˜ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì„ ìƒì„±í•œë‹¤(`vi build.sh`). ê·¸ë¦¬ê³  ì•„ë˜ ë‚´ìš©ì„ ì…ë ¥í•œë‹¤.
   - `build.sh`

   - ```bash
     #!/bin/bash
     IP=`curl -s 169.254.169.254/latest/meta-data/public-ipv4`
     START="$IP start deploying app!"
     END="$IP end deploying app!"
     
     #real deploy script
     CK=`aws s3 cp jaríŒŒì¼ëª… s3://ë²„í‚·ì´ë¦„/íŒŒì¼ì´ë¦„
     if [[ ! $CK ]]; then
     echo "no need to build"
     exit 0
     fi
     
     curl -X POST --data-urlencod "payload={\"text\": \"$START\"}" WebhookURLì£¼ì†Œ
     
     /usr/bin/fuser -k 8080/tcp
     aws s3 cp s3://ë²„í‚·ì´ë¦„/jaríŒŒì¼ëª….jar ./jaríŒŒì¼ëª….jar
     nohup java -jar jaríŒŒì¼ëª….jar &
     aws s3 rm s3://ë²„í‚·ì´ë¦„/jaríŒŒì¼ëª….jar
     
     curl -X POST --data-urlencod "payload={\"text\": \"$END\"}" WebhookURLì£¼ì†Œ
     
     echo "Deploy end: `date`"
     ```

   - ë™ì‘ : `./build.sh` ì‹¤í–‰ ì‹œ, s3 ë²„í‚·ì— ë¹Œë“œ íŒŒì¼(.jar)ì´ ìˆìœ¼ë©´ ë°°í¬ë¥¼ ì§„í–‰í•˜ê³  ë°°í¬ ì¢…ë£Œ ì‹œê°„ì„ ì¶œë ¥í•œë‹¤. ë°˜ëŒ€ë¡œ s3ë²„í‚·ì— ë¹Œë“œ íŒŒì¼ì´ ì—†ìœ¼ë©´ ë°°í¬ë¥¼ í•˜ì§€ ì•Šê³  `no need to build`ë¥¼ ì¶œë ¥í•œë‹¤.

   - `curl -s 169.254.169.254/latest/meta-data/public-ipv4`

     - í˜„ì¬ ec2ì¸ìŠ¤í„´ìŠ¤ì˜ public ipv4 ì£¼ì†Œë¥¼ ì•Œì•„ë‚¸ë‹¤.

   - `WebhookURLì£¼ì†Œ` 

     - 7.ì—ì„œ ë°›ì•„ ë‘” ì£¼ì†Œë¥¼ ë„£ëŠ”ë‹¤. ë°°í¬ ì‹œì‘/ì¢…ë£Œ ì‹œ í•´ë‹¹ ì±„ë„ì— ì•Œë¦¼ì´ ì „ì†¡ë¨

   - `/usr/bin/fuser -k 8080/tcp`

     - í¬íŠ¸ ë²ˆí˜¸(`8080`)ë¥¼ ì´ìš©í•´ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ì£½ì´ëŠ” ì½”ë“œ.
     - ì¬ë°°í¬ ì „ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ì£½ì—¬ì•¼ í•˜ë¯€ë¡œ í•„ìš”.

   - `jaríŒŒì¼ëª….jar`

     - 4.ì—ì„œ ì§€ì •í•œ íŒŒì¼ ì´ë¦„ì— `.jar` í™•ì¥ìë¥¼ ë¶™ì„. ì˜ˆë¥¼ ë“¤ì–´ `airbnb.jar`.

   - ì´ì œ ë¡œì»¬ì—ì„œ ec2 ì¸ìŠ¤í„´ìŠ¤ì— jaríŒŒì¼ì„ ë³´ë‚¸ í›„, ec2ì—ì„œ  `./build.sh` ë§Œ ì‹¤í–‰í•˜ë©´ ë°°í¬ê°€ ìë™ìœ¼ë¡œ ë˜ë©° ìŠ¬ë™ ì•Œë¦¼ë„ ì˜¨ë‹¤.

8. (ë¡œì»¬) 'ë¡œì»¬ ë¹Œë“œ - jaríŒŒì¼ s3ë¡œ ë³µì‚¬' ê³¼ì • ìë™í™”

   - ë¡œì»¬ í”„ë¡œì íŠ¸ íŒŒì¼ ìœ„ì¹˜ì—ì„œë„ ë§ˆì°¬ê°€ì§€ë¡œ `build.sh`íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ, jaríŒŒì¼ ë¹Œë“œ ë° aws s3ì— ë³µì‚¬í•˜ëŠ” ê³¼ì •ì„ ìë™í™”í•  ìˆ˜ ìˆë‹¤.

   - `build.sh`

   - ```bash
     #!/bin/bash
     ./gradlew build jar
     aws s3 cp build/libs/ë¡œì»¬jaríŒŒì¼ëª….jar s3://ë²„í‚·ì´ë¦„/jaríŒŒì¼ëª….jar
     echo "Done!"
     ```

   - ì´í›„ ë¡œì»¬ì—ì„œë„ `./build.sh` ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¹Œë“œ, s3ë³µì‚¬ ê³¼ì •ì„ ìë™í™”í•  ìˆ˜ ìˆë‹¤.

   - ì´ì œ ì¬ë°°í¬ë¥¼ ì›í•  ë•Œ, ë¡œì»¬ì—ì„œ `./build.sh` í›„ ec2ì¸ìŠ¤í„´ìŠ¤ì—ì„œ `./build.sh` ì…ë ¥í•˜ë©´ ì¬ë°°í¬ê°€ ëë‚œë‹¤.

9. (ec2) crontabìœ¼ë¡œ 1ë¶„ë§ˆë‹¤ `build.sh`ì‹¤í–‰í•˜ê¸°

   - ec2 ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì† í›„ `crontab -e`ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•œë‹¤.

   - ì´í›„ ë§¨ ì•„ë˜ì— ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•œë‹¤.

   - ```bash
     * * * * * 	 /home/ubuntu/build.sh >> log.txt 2>&1
     ```

   - 1ë¶„ë§ˆë‹¤ `build.sh`ë¥¼ ì‹¤í–‰í•˜ê³ , ê·¸ ë¡œê·¸ë¥¼ `log.txt`ì— ë‚¨ê¸´ë‹¤.

   - `cat log.txt`ë¥¼ í†µí•´ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.



## í”„ë¡œì íŠ¸ - Nginxë¥¼ ì‚¬ìš©í•´ ì›í•˜ëŠ” í¬íŠ¸ë¡œ HTTP Request ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ê¸°

> ì¶œì²˜ğŸ™‡â€â™‚ï¸
>
>  https://velog.io/@damiano1027/Nginx-Nginx%EC%99%80-SpringBoot-%EB%82%B4%EC%9E%A5-Tomcat-%EC%97%B0%EB%8F%99

ì—ì–´ë¹„ì—”ë¹„ í”„ë¡œì íŠ¸ì—ì„œ 3000í¬íŠ¸ë¥¼ ì£¼ë¡œ ì‚¬ìš©í•œë‹¤ëŠ” í”„ë¡ íŠ¸ ë¶„ë“¤ì„ ìœ„í•´ Nginxë¡œ ë¦¬ë‹¤ì´ë ‰íŒ…ì„ í•´ ë³´ì•˜ë‹¤.

(ìœ„ ë§í¬ë¥¼ ì½ê³  ë”°ë¼í–ˆë‹¤ - ìì„¸í•œ ì„¤ëª…ì€ ìœ„ ë§í¬ë¥¼ ë‹¤ì‹œ ì½ì–´ë´ì•¼ê² ë‹¤)

1. (ec2) Nginx ì„¤ì¹˜ ë° ì‹œì‘

   ```bash
   sudo apt-get install nginx
   sudo service nginx start
   ```

2. (ec2) ec2 ì¸ìŠ¤í„´ìŠ¤ [ë³´ì•ˆ] - [ë³´ì•ˆê·¸ë£¹] - [ì¸ë°”ìš´ë“œ ì„¤ì •]ì—ì„œ ì›í•˜ëŠ” í¬íŠ¸ ì—´ì–´ì£¼ê¸°

3. (ec2) ì„¤ì •íŒŒì¼ ìƒì„± ë° ì ìš©

   ```bash
   cd /etc/nginx/sites-available
   sudo vi test.conf
   ```

   ë§Œë“¤ì–´ì§„ `test.conf`ì— ì•„ë˜ ë‚´ìš© ë„£ê¸°

   ```bash
   server {
       listen 3000;
       listen [::]:3000;
   
       server_name ec2í¼ë¸”ë¦­IPv4DNSì£¼ì†Œ ;
    
       location / {
            proxy_pass http://ec2í¼ë¸”ë¦­IPv4:8080;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;
       }
   }
   ```

   - 3000ë²ˆ í¬íŠ¸ë¡œ ec2ì¸ìŠ¤í„´ìŠ¤ì— ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  requestì— ëŒ€í•´, 8080í¬íŠ¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ê²Œ í•´ì£¼ëŠ” ë‚´ìš©ì´ë‹¤.

4. (ec2) sites-enabledì— ì‹¬ë³¼ë¦­ ë§í¬ ë§Œë“¤ê¸°

   - ìœ„ ì„¤ì •íŒŒì¼ ì €ì¥ í›„
   - `sudo ln -s /etc/nginx/sites-available/test.conf /etc/nginx/sites-enabled`
   - `cd /etc/nginx/sites-enabled`
   - `ls -l`
   - test.conf íŒŒì¼(ì‹¬ë³¼ë¦­ ë§í¬)ì´ ì¶”ê°€ë˜ì–´ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
   - default ë„ ì¡´ì¬í•  ê²ƒì´ë‹¤. ì´ íŒŒì¼ì€ ì‚­ì œí•´ì•¼ í•œë‹¤. (`rm -rf default` ë˜ëŠ” `sudo rm -rf default`)

5. (ec2) Ngnix ì¬ì‹œì‘ ë° í™•ì¸

   - `sudo service nginx reload` ë˜ëŠ” `sudo service nginx restart`ë¡œ Nginxë¥¼ ì¬ì‹œì‘í•œë‹¤
   - ë¸Œë¼ìš°ì €ì—ì„œ í•´ë‹¹ ec2ì„œë²„ì˜ 3000ë²ˆ í¬íŠ¸ë¡œ ì ‘ì†í•´ ë³¸ë‹¤.
   - 8080í¬íŠ¸ë¡œ ì ‘ì†í•  ë•Œì™€ ë™ì¼í•œ í˜ì´ì§€ê°€ ë‚˜ì˜¨ë‹¤ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì„±ê³µ!















