**[210604]**



# publicì„ í†µí•´ private ì ‘ì†í•˜ê¸°

> [https://velog.io/@yeon/public-subnet%EA%B3%BC-private-subnet%EC%97%90-%EC%9B%B9%EC%84%9C%EB%B2%84%EC%99%80-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EB%B6%84%EB%A6%AC%ED%95%B4%EC%84%9C-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0](https://velog.io/@yeon/public-subnet%EA%B3%BC-private-subnet%EC%97%90-%EC%9B%B9%EC%84%9C%EB%B2%84%EC%99%80-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EB%B6%84%EB%A6%AC%ED%95%B4%EC%84%9C-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0) ì—° ë¸”ë¡œê·¸ì—ì„œ ì „ì²´ì ì¸ ê³¼ì • ì°¸ê³ í•˜ê¸°

> [https://rutesun.wordpress.com/2015/02/04/git-bash-%EA%B0%9C%EC%9D%B8%ED%82%A4-%EB%93%B1%EB%A1%9D%EC%8B%9C-%EC%97%90%EB%9F%AC/](https://rutesun.wordpress.com/2015/02/04/git-bash-%EA%B0%9C%EC%9D%B8%ED%82%A4-%EB%93%B1%EB%A1%9D%EC%8B%9C-%EC%97%90%EB%9F%AC/) ì—ì„œ ssh agent ì´ˆê¸° ì…‹íŒ… ì°¸ê³ í•˜ê¸°

privateì¸ìŠ¤í„´ìŠ¤(DB ì¸ìŠ¤í„´ìŠ¤)ì— ì ‘ì†í•˜ê¸° ìœ„í•´ì„œëŠ” publicì¸ìŠ¤í„´ìŠ¤(ì„œë²„ ì¸ìŠ¤í„´ìŠ¤)ì—ì„œ ì ‘ì†í•  ë•Œ privateì¸ìŠ¤í„´ìŠ¤ì˜ í‚¤íŒŒì¼(.pem)ì„ í•¨ê»˜ ê°€ì§€ê³  ì ‘ì†í•´ì•¼ í•œë‹¤.  
ì´ ë•Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ssh agentì´ë‹¤.  
sshì ‘ì† ì‹œ agentë¥¼ ë¶™ì—¬ì„œ, ê·¸ agentê°€ í‚¤íŒŒì¼ì„ ê°€ì§€ê³  í•¨ê»˜ ì ‘ì†í•˜ë„ë¡ í•œë‹¤.



> **â— private, public í‚¤íŒŒì¼(.pem)ì´ ì¡´ì¬í•˜ëŠ” ê²½ë¡œì—ì„œ ì•„ë˜ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•´ì•¼ í•œë‹¤**



- `ssh-agent -s` : ssh-agentë¥¼ ì‹œì‘í•œë‹¤
- `ssh-add ~/í‚¤íŒŒì¼ê²½ë¡œ` : ssh-agentì— í‚¤ë¥¼ ë“±ë¡í•œë‹¤.
- `eval $(ssh-agent)` : ssh-agentë¥¼ ì‹œì‘í•œë‹¤ 
  - (`Could not open a connection to your authentication agent` ì˜¤ë¥˜ ë°œìƒì‹œ ì“°ëŠ” ì»¤ë§¨ë“œ)
- `ssh-add -K privateí‚¤íŒŒì¼ì´ë¦„.pem` : privateí‚¤íŒŒì¼ì„ ssh agentì— ì¶”ê°€í•œë‹¤. (agentë¼ëŠ” ìš”ì›ì—ê²Œ í‚¤íŒŒì¼ì„ ë“¤ë ¤ ë³´ë‚¸ë‹¤)
- `ssh -A -i "publicí‚¤íŒŒì¼ì´ë¦„.pem" ec2ì‚¬ìš©ìì´ë¦„@publicì¸ìŠ¤í„´ìŠ¤ipv4DNSì£¼ì†Œ` : publicì¸ìŠ¤í„´ìŠ¤ í‚¤íŒŒì¼ë¡œ publicì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•˜ë˜ `-A`ì˜µì…˜ìœ¼ë¡œ ssh agentì™€ í•¨ê»˜ ì ‘ì†í•œë‹¤.
- ìœ„ ëª…ë ¹ì–´ë¡œ publicì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•œ ë’¤, ê·¸ publicì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë‹¤ì‹œ `ssh -i "privateí‚¤íŒŒì¼ì´ë¦„.pem" ec2ì‚¬ìš©ìì´ë¦„@privateì¸ìŠ¤í„´ìŠ¤ipv4ì£¼ì†Œ` : privateí‚¤íŒŒì¼ë¡œ privateì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•œë‹¤.



---



## [airbnbí”„ë¡œì íŠ¸] JWT ì½”ë“œ ì„¤ëª… 

> ì¶œì²˜ : ì „ì²´ ì½”ë“œ ì¶œì²˜ëŠ” https://ocblog.tistory.com/56, ì„¤ëª…ì€ yeonì´ í•´ ì£¼ì…¨ìŠµë‹ˆë‹¤ğŸ™‡â€â™‚ï¸

### JWT í† í° ì™œ ì“°ëŠ”ê°€?

ë¡œê·¸ì¸ ì‹œ ì„œë²„ê°€ í† í°ì„ ë§Œë“¤ì–´ í´ë¼ì´ì–¸íŠ¸ì— ë°œê¸‰í•´ ì¤€ë‹¤.

ì´í›„ ë¡œê·¸ì¸ì´ í•„ìš”í•œ URLì—ì„œ, í—¤ë”ì— í† í°ì´ ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.

- í† í°ì´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ë“¤ì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤.

- í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ê°„ì£¼í•˜ê³  ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ë“¤ì„ ì´ìš©í•  ìˆ˜ ì—†ë‹¤.



### ì¸í„°ì…‰í„° interceptor

ì¸í„°ì…‰í„° : ì»¨íŠ¸ë¡¤ëŸ¬ì— ì˜¤ê¸° ì „ì— ì¡´ì¬í•˜ëŠ” ë‹¨ê³„.

í”„ë¡ íŠ¸ê°€ HTTP Headerì— ìš°ë¦¬ê°€ ë°œê¸‰í•œ í† í°ì„ ë‹´ì•„ì„œ ë³´ë‚´ì£¼ë©´ (`"Authorization" : Bearer í† í°`) ìš°ë¦¬ê°€ ë°œê¸‰í•œ í† í°ì´ ë§ëŠ”ì§€ í™•ì¸í•œë‹¤.

í† í° í™•ì¸ ì‘ì—…ì´ ë°˜ë³µì ì´ê¸° ë•Œë¬¸ì—, ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì•„ë‹Œ ì¸í„°ì…‰í„°ë¥¼ ë”°ë¡œ ë§Œë“¤ì–´ ê±°ê¸°ì—ì„œ ì²˜ë¦¬í•˜ê²Œ í•˜ëŠ” ê²ƒì´ë‹¤. 

(ì•„ë˜ì˜ `BearerInterceptor` ì½”ë“œ ì„¤ëª… ì°¸ì¡°)



### `AppConfig`

```java
@Configuration
public class AppConfig implements WebMvcConfigurer {

    private static final Logger logger = LoggerFactory.getLogger(AppConfig.class);

    private final BearerAuthInterceptor bearerAuthInterceptor;

    public AppConfig(BearerAuthInterceptor bearerAuthInterceptor) { // ì¸í„°ì…‰í„° êµ¬í˜„ì²´ë¥¼ ë§Œë“¤ì–´ ë“±ë¡í•¨
        this.bearerAuthInterceptor = bearerAuthInterceptor;
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        logger.info(">>> ì¸í„°ì…‰í„° ë“±ë¡");
        registry.addInterceptor(bearerAuthInterceptor).addPathPatterns("/api/booking")
                .addPathPatterns("/api/booking/{bookingId}")
                .addPathPatterns("/api/rooms/{userId}/wish/{roomId}");
    }
}
```

`AppConfig`ëŠ” `WebMvcConfigurer`ë¥¼ êµ¬í˜„í•´ì•¼ í•œë‹¤.

- `addInterceptors()`
  - ì¸í„°ì…‰í„°ë¥¼ ë“±ë¡í•  ë•Œ, ì¸í„°ì…‰í„°ë¥¼ ê±°ì¹  urlì„ ë“±ë¡í•œë‹¤.
  - = ì¦‰ ë¡œê·¸ì¸ìƒíƒœì¸ì§€ í™•ì¸ì´ ë˜ì–´ì•¼ë§Œ ì œê³µë˜ëŠ” ê¸°ëŠ¥ê³¼ ì—°ê²°ëœ urlë“¤ì„ ë“±ë¡í•˜ë©´ ëœë‹¤.

### `BearerAuthInterceptor`

```java
package com.codesquad.airbnb.jwt;

import com.codesquad.airbnb.exception.TokenEmptyException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component
public class BearerAuthInterceptor implements HandlerInterceptor {

    private static final Logger logger = LoggerFactory.getLogger(BearerAuthInterceptor.class);

    private AuthorizationExtractor authorizationExtractor;
    private JwtTokenProvider jwtTokenProvider;

    public BearerAuthInterceptor(AuthorizationExtractor authorizationExtractor, JwtTokenProvider jwtTokenProvider) {
        this.authorizationExtractor = authorizationExtractor;
        this.jwtTokenProvider = jwtTokenProvider;
    }

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        logger.info(">>> interceptor.preHandle í˜¸ì¶œ");
        String token = authorizationExtractor.extract(request, "Bearer");
        if (token.isEmpty()) {
            throw new TokenEmptyException();
        }

        if (!jwtTokenProvider.validateToken(token)) {
            throw new IllegalArgumentException("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°");
        }

        Long id = jwtTokenProvider.getSubject(token);
        request.setAttribute("id", id);
        return true;
    }
}

```

`HandlerInterceptor`ë¥¼ êµ¬í˜„í•œ `BearerAuthInterceptor`ì¸í„°ì…‰í„°ë¥¼,  `@Configuration`ì´ ë¶™ì€ `AppConfig`ì—ì„œ ì¸í„°ì…‰í„°ë¡œ ë“±ë¡í•œë‹¤. (`addInterceptors()`)

- `preHandle()` : `HandlerInterceptor`ì˜ ì¶”ìƒë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”©í•œ ê²ƒ. 
  - ì´ ê²°ê³¼ê°’ì´ trueì—¬ì•¼ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤.
  - trueê°€ ë°˜í™˜ì´ ë˜ì–´ì•¼ë§Œ controllerì— ë„ë‹¬í•œë‹¤.
  - request-ì¸í„°ì…‰í„° - í—¤ë”ì— ìˆëŠ” í† í°ì„ ì¶”ì¶œí•œë‹¤. (`authorizationExtractor.extract()`)
  - í† í°ì´ ë¹„ì–´ìˆë‹¤ = ë¡œê·¸ì¸ì´ ì•ˆ ë˜ì–´ìˆë‹¤ -> ì˜ˆì™¸ ë°œìƒ
  - `jwtTokenProvider.validateToken()` : ìœ íš¨í•œ í† í°ì¸ì§€ ê²€ì¦. ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ
  - í™•ì¸ì´ ëë‚˜ë©´ (ìš°ë¦¬ëŠ” userIdë¥¼ ì´ìš©í•´ í† í°ì„ ë§Œë“œëŠ”ë°) í† í°ì„ ë””ì½”ë”©í•´, í† í°ì— ë“¤ì–´ìˆëŠ” userIdë¥¼ í™•ì¸í•œë‹¤(`jwtTokenProvider.getSubject()`).

### `AuthorizationExtractor`

```java
package com.codesquad.airbnb.jwt;

import org.apache.logging.log4j.util.Strings;
import org.springframework.stereotype.Component;

import javax.servlet.http.HttpServletRequest;
import java.util.Enumeration;

@Component
public class AuthorizationExtractor {

    public static final String AUTHORIZATION = "Authorization";
    public static final String ACCESS_TOKEN_TYPE = AuthorizationExtractor.class.getSimpleName();

    public String extract(HttpServletRequest request, String type) {
        Enumeration<String> headers = request.getHeaders(AUTHORIZATION);
        while (headers.hasMoreElements()) {
            String value = headers.nextElement();
            if (value.toLowerCase().startsWith(type.toLowerCase())) {
                return value.substring(type.length()).trim();
            }
        }
        return Strings.EMPTY;
    }
}

```

- HTTP headerì— ë“¤ì–´ ìˆëŠ” í† í°ì„ ì¶”ì¸¨í•˜ëŠ” ì—­í• ì˜ ë©”ì„œë“œì´ë‹¤.

### `JwtTokenProvider`

```java
package com.codesquad.airbnb.jwt;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jws;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import java.util.Base64;
import java.util.Date;

@Component
public class JwtTokenProvider {

    private final Logger logger = LoggerFactory.getLogger(JwtTokenProvider.class);

    private String secretKey;
    private long validityInMilliseconds;

    public JwtTokenProvider(@Value("&{security.jwt.token.secret-key}") String secretKey, @Value("${security.jwt.token.expire-length}") long validityInMilliseconds) {
        this.secretKey = Base64.getEncoder().encodeToString(secretKey.getBytes());
        this.validityInMilliseconds = validityInMilliseconds;
    }

    // í† í° ìƒì„±
    public String createToken(Long id) {
        Claims claims = Jwts.claims().setSubject(String.valueOf(id));

        Date now = new Date();
        Date validity = new Date(now.getTime() + validityInMilliseconds);
        logger.info("now: {}", now);
        logger.info("validity: {}", validity);

        return Jwts.builder()
                .setClaims(claims)
                .setIssuedAt(now)
                .setExpiration(validity)
                .signWith(SignatureAlgorithm.HS256, secretKey)
                .compact();
    }

    // í† í°ì—ì„œ ê°’ ì¶”ì¶œ
    public Long getSubject(String token) {
        return Long.valueOf(Jwts.parser()
                .setSigningKey(secretKey)
                .parseClaimsJws(token)
                .getBody()
                .getSubject());
    }

    // ìœ íš¨í•œ í† í°ì¸ì§€ í™•ì¸
    public boolean validateToken(String token) {
        Jws<Claims> claims = Jwts.parser().setSigningKey(secretKey).parseClaimsJws(token);
        return !claims.getBody().getExpiration().before(new Date());
    }
}

```

- `JwtTokenProvider` : í† í°ì„ ì•”í˜¸í™”, ë³µí˜¸í™”, ê²€ì¦ ë“±ì˜ ì‘ì—…ì„ í•˜ëŠ” í•˜ëŠ” í´ë˜ìŠ¤
- `getSubject()` : í† í°ì„ ê°’ì„ ì¶”ì¶œí•´ ë°›ì•„ì˜¤ëŠ” ë©”ì„œë“œ
- í† í° ìƒì„±, ì¶”ì¶œ, ìœ íš¨ì„± í™•ì¸ ë©”ì„œë“œë“¤ì´ ë“¤ì–´ìˆë‹¤.
- í† í° ìƒì„±ì— í•„ìš”í•œ ì‹œí¬ë¦¿ í‚¤ì™€ ìœ íš¨ê¸°ê°„ ë“±ì„ `application.properties`ì˜ ì„¤ì •ì—ì„œ ê°€ì ¸ì™€ í† í°ì„ ë§Œë“ ë‹¤.
- ìƒì„± : `Jwts`ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í•´ ì‹œí¬ë¦¿ í‚¤ë¡œ í† í° ì•”í˜¸í™”ì™€ ìœ íš¨ê¸°ê°„ì„ ì„¤ì •í•œë‹¤.
  - í† í°ì˜ sub ë“±ì„ claimìœ¼ë¡œ ì„¤ì •í•œë‹¤.

### `TokenRespnose`

```java
package com.codesquad.airbnb.jwt;

public class TokenResponse {

    private String accessToken;
    private String tokenType;

    public TokenResponse(String accessToken, String tokenType) {
        this.accessToken = accessToken;
        this.tokenType = tokenType;
    }

    public String getAccessToken() {
        return accessToken;
    }

    public String getTokenType() {
        return tokenType;
    }
}

```

- TokenResponse : JWTí† í° ê°’ì„ ë‹´ì•„ ë³´ë‚´ê¸° ìœ„í•œ Response DTO í´ë˜ìŠ¤ì´ë‹¤.



---



## í”„ë¡ íŠ¸ ë°°í¬

í”„ë¡ íŠ¸ ë°°í¬ ë¹Œë“œíŒŒì¼ì„ ë°›ì•„ì˜¨ë‹¤ (npm?)

ê¸°ì¡´ Nginxì— ì—´ì–´ ë‘” ì„œë²„ ì•„ë˜(80)ì— í”„ë¡ íŠ¸ íŒŒì¼ ë°°í¬ë¥¼ ìœ„í•œ ì„œë²„(88)ë¥¼ ì¶”ê°€ë¡œ ì—´ì–´ ì¤€ë‹¤.

```
server {
    listen 80;
    listen [::]:80;

	server_name ec2-54-180-145-53.ap-northeast-2.compute.amazonaws.com;

    location / {
        proxy_pass http://54.180.145.53:8080;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        }
}

server {
    listen 88;
    listen [::]:88;

    location / {
        root /home/ubuntu/airbnb/FE/dist;
        index index.html;
    }

}
```

