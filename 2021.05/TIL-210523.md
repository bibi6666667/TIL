**[210523]**



## Spring JdbcTemplateì— ëŒ€í•œ ê³µì‹ë¬¸ì„œ ê°€ì´ë“œ 

(Kê°€ ì•Œë ¤ì£¼ì…¨ë‹¤ğŸ™‡â€â™€ï¸ ê°ì‚¬í•©ë‹ˆë‹¤!)

3.1 Choosing an Approach for JDBC Database Accessì—ì„œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì½ê³ 

3.3.1. UsingJdbcTemplate ë¶€ë¶„ë¶€í„° ë³´ë©´ ë  ë“¯!

https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#jdbc



### 3.1 Choosing an Approach for JDBC Database Access (JDBC ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ë°©ì‹ ì„ íƒ)

`JdbcTemplate`, `SimpleJdbcInsert`, `SimpleJdbcCall`, ë“±ë“±ì˜ ë°©ì‹ë“¤ì´ JDBC ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ì„ ì‰½ê²Œ í•œë‹¤.

ì…‹ ì¤‘ í•˜ë‚˜ë¥¼ ê³¨ë¼ ì“°ë”ë¼ë„, ë‚˜ë¨¸ì§€ ë°©ì‹ì„ ì„ì–´ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤.

- `JdbcTemplate` : ê¸°ë³¸ì ì´ë©° ê°€ì¥ ì¸ê¸° ìˆëŠ” ìŠ¤í”„ë§ JDBC ì ‘ê·¼ë²•. ê°€ì¥ ë‚®ì€ ìˆ˜ì¤€ì˜ ì ‘ê·¼. 
  - ë‚˜ë¨¸ì§€ ë°©ì‹ë“¤ì€ ëª¨ë‘ ì´ ë°©ì‹ì˜ í™•ì¥ì´ë‹¤.
- `NamedParameterJdbcTemplate` : JDBCì˜ `?`ë°©ì‹ ëŒ€ì‹  ëª…ëª…ëœ ë§¤ê°œë³€ìˆ˜ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•¨. SQLë¬¸ì— ì—¬ëŸ¬ íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì§€ê³  ìˆì„ ë•Œ ìœ ìš©í•¨.
- `SimpleJdbcInsert`, `SimpleJdbcCall` : í•„ìš”í•œ êµ¬ì„±ì˜ ê·œëª¨ë¥¼ ì œí•œí•˜ê¸° ìœ„í•´ ë°ì´í„°ë² ì´ìŠ¤ ë©”íƒ€ë°ì´í„°ë¥¼ ìµœì í™”í•œë‹¤.

### 3.3.1 Using `JdbcTemplate` 

`JdbcTemplate`ëŠ” JDBC ì½”ì–´ íŒ¨í‚¤ì§€ì˜ ì¤‘ì‹¬ í´ë˜ìŠ¤ì´ë‹¤.

- ìì›ì˜ ìƒì„± ë° ë¦´ë¦¬ìŠ¤ë¥¼ ë‹¤ë£¬ë‹¤. 
- JDBCì˜ ì¤‘ì‹¬ ì›Œí¬í”Œë¡œìš°ì˜ ê¸°ë³¸ ì‘ì—…ì„ ë‹¤ë£¬ë‹¤.

`JdbcTemplate`í´ë˜ìŠ¤ëŠ”..

- SQLì¿¼ë¦¬ë“¤ì„ ì‹¤í–‰í•¨
- êµ¬ë¬¸ê³¼ ì €ì¥ëœ í”„ë¡œì‹œì € í˜¸ì¶œì„ ìˆ˜ì •í•¨
- `ResultSet` ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ë°˜ë³µì„ ì‹¤í–‰í•¨
- ë°˜í™˜ëœ ë§¤ê°œë³€ìˆ˜ ê°’ì„ ì¶”ì¶œí•¨
- JDBC ì˜ˆì™¸ë¥¼ ì¡ì•„ ë” ì¼ë°˜ì ì´ê³  ìœ ìµí•˜ê²Œ ë³€í™˜í•¨

â€» `DataSource`ëŠ” í•­ìƒ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì—ì„œ ë¹ˆìœ¼ë¡œ êµ¬ì„±í•´ì•¼ í•¨.

#### SELECT ì¿¼ë¦¬

- Stringì„ ì°¾ëŠ” ì¿¼ë¦¬

  - idê°€ 1212ì¸ ë°°ìš°ì˜ ì„±ì„ ê°€ì ¸ì˜´

  - ```java
    String lastName = this.jdbcTemplate.queryForObject(
            "select last_name from t_actor where id = ?",
            String.class, 1212L);
    ```

- ë°”ì¸ë“œ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬

  - ì´ë¦„ì´ Joeì¸ ë°°ìš°ì˜ ìˆ˜ë¥¼ ì…ˆ

  - ```java
    int countOfActorsNamedJoe = this.jdbcTemplate.queryForObject(
            "select count(*) from t_actor where first_name = ?", Integer.class, "Joe");
    ```

- ê´€ê³„ìˆëŠ” í–‰(row)ì˜ ìˆ˜ë¥¼ ì„¸ëŠ” ì¿¼ë¦¬

  - ë°°ìš°ì˜ ìˆ˜ë¥¼ ì…ˆ?

  - ```java
    int rowCount = this.jdbcTemplate.queryForObject("select count(*) from t_actor", Integer.class);
    ```

- í•˜ë‚˜ì˜ ë„ë©”ì¸ ê°ì²´ë¥¼ ì°¾ì•„ì„œ ê°’ì„ ì±„ìš°ëŠ” ì¿¼ë¦¬

  - ì•„ì´ë””ê°€ 1212ì¸ ë°°ìš°ì˜ ì„±ê³¼ ì´ë¦„ì„ ì°¾ìŒ

  - ```java
    Actor actor = jdbcTemplate.queryForObject(
            "select first_name, last_name from t_actor where id = ?",
            (resultSet, rowNum) -> {
                Actor newActor = new Actor();
                newActor.setFirstName(resultSet.getString("first_name"));
                newActor.setLastName(resultSet.getString("last_name"));
                return newActor;
            },
            1212L);
    ```

- ì—¬ëŸ¬ ë„ë©”ì¸ ê°ì²´(ë¦¬ìŠ¤íŠ¸)ë¥¼ ì°¾ì•„ì„œ ê°’ì„ ì±„ìš°ëŠ” ì¿¼ë¦¬

  - ë°°ìš°ë“¤ì˜ ì„±ê³¼ ì´ë¦„ì„ ì°¾ìŒ

  - ```java
    List<Actor> actors = this.jdbcTemplate.query(
            "select first_name, last_name from t_actor",
            (resultSet, rowNum) -> {
                Actor actor = new Actor();
                actor.setFirstName(resultSet.getString("first_name"));
                actor.setLastName(resultSet.getString("last_name"));
                return actor;
            });
    ```

- í•˜ë‚˜ì˜ ë„ë©”ì¸ ê°ì²´ & ì—¬ëŸ¬ ë„ë©”ì¸ ê°ì²´ ë¥¼ ì°¾ì„ ë•Œ `RowMapper` ì½”ë“œê°€ ì¤‘ë³µë˜ëŠ” ê²½ìš° ë‹¤ìŒê³¼ ê°™ì´ ì¤‘ë³µì„ ì œê±°í•  ìˆ˜ ìˆë‹¤

  - ```java
    private final RowMapper<Actor> actorRowMapper = (resultSet, rowNum) -> {
        Actor actor = new Actor();
        actor.setFirstName(resultSet.getString("first_name"));
        actor.setLastName(resultSet.getString("last_name"));
        return actor;
    };
    
    public List<Actor> findAllActors() {
        return this.jdbcTemplate.query( "select first_name, last_name from t_actor", actorRowMapper);
    }
    ```

#### INSERT, UPDATE, DELETE ì¿¼ë¦¬ ê·¸ë¦¬ê³  `JdbcTemplate`

`update(...)` ë©”ì„œë“œë¥¼ í†µí•´ INSERT, UPDATE, DELETEë¥¼ ëª¨ë‘ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤. ë§¤ê°œë³€ìˆ˜ ê°’ì€ ë³´í†µ ë³€ìˆ˜ / ê°ì²´ ë°°ì—´ë¡œ ì œê³µëœë‹¤.

- ìƒˆ ì—”íŠ¸ë¦¬ë¥¼ ì‚½ì…í•˜ëŠ” ì¿¼ë¦¬ 

  - ì„±ì´ Watling, ì´ë¦„ì´ Leonorì¸ ë°°ìš°ë¥¼ ì¶”ê°€í•œë‹¤

  - ```java
    this.jdbcTemplate.update(
            "insert into t_actor (first_name, last_name) values (?, ?)",
            "Leonor", "Watling");
    ```

- ê¸°ì¡´ ì—”íŠ¸ë¦¬ë¥¼ ìˆ˜ì •í•˜ëŠ” ì¿¼ë¦¬

  - idê°€ 5276ì¸ ë°°ìš°ì˜ ì´ë¦„ì„ Banjoë¡œ ìˆ˜ì •í•œë‹¤

  - ```java
    this.jdbcTemplate.update(
            "update t_actor set last_name = ? where id = ?",
            "Banjo", 5276L);
    ```

- ê¸°ì¡´ ì—”íŠ¸ë¦¬ë¥¼ ì‚­ì œí•˜ëŠ” ì¿¼ë¦¬

  - idê°€ `actorId`ì¸ ë°°ìš°ë¥¼ ì‚­ì œí•œë‹¤

  - ```java
    this.jdbcTemplate.update(
            "delete from t_actor where id = ?",
            Long.valueOf(actorId));
    ```

#### `JdbcTemplate` ëª¨ë²” ì‚¬ë¡€

ì•„ë˜ì™€ ê°™ì´ `DataSource`ëŠ” ì„¤ì • íŒŒì¼ì—ì„œ ìƒì„±í•˜ê³ (Spring Configuration), ê·¸ ë¹ˆì„ DAOí´ë˜ìŠ¤ì— ì˜ì¡´ì„± ì£¼ì…í•˜ëŠ” ë°©ì‹ì´ ê¶Œì¥ëœë‹¤.

- DAO í´ë˜ìŠ¤	

  ```java
  public class JdbcCorporateEventDao implements CorporateEventDao {
  
      private JdbcTemplate jdbcTemplate;
  
      public void setDataSource(DataSource dataSource) {
          this.jdbcTemplate = new JdbcTemplate(dataSource);
      }
  
      // JDBC-backed implementations of the methods on the CorporateEventDao follow...
  }
  ```

- ì„¤ì • íŒŒì¼ (XML)

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:context="http://www.springframework.org/schema/context"
      xsi:schemaLocation="
          http://www.springframework.org/schema/beans
          https://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.springframework.org/schema/context
          https://www.springframework.org/schema/context/spring-context.xsd">
  
      <bean id="corporateEventDao" class="com.example.JdbcCorporateEventDao">
          <property name="dataSource" ref="dataSource"/>
      </bean>
  
      <bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
          <property name="driverClassName" value="${jdbc.driverClassName}"/>
          <property name="url" value="${jdbc.url}"/>
          <property name="username" value="${jdbc.username}"/>
          <property name="password" value="${jdbc.password}"/>
      </bean>
  
      <context:property-placeholder location="jdbc.properties"/>
  
  </beans>
  ```

ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì˜ì¡´ì„± ì£¼ì…ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” ì»´í¬ë„ŒíŠ¸ìŠ¤ìº”ê³¼ ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

- DAO í´ë˜ìŠ¤

  ```java
  @Repository 
  public class JdbcCorporateEventDao implements CorporateEventDao {
  
      private JdbcTemplate jdbcTemplate;
  
      @Autowired 
      public void setDataSource(DataSource dataSource) {
          this.jdbcTemplate = new JdbcTemplate(dataSource); 
      }
  
      // JDBC-backed implementations of the methods on the CorporateEventDao follow...
  }
  ```

- ì„¤ì • íŒŒì¼ (XML)

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:context="http://www.springframework.org/schema/context"
      xsi:schemaLocation="
          http://www.springframework.org/schema/beans
          https://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.springframework.org/schema/context
          https://www.springframework.org/schema/context/spring-context.xsd">
  
      <!-- Scans within the base package of the application for @Component classes to configure as beans -->
      <context:component-scan base-package="org.springframework.docs.test" />
  
      <bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
          <property name="driverClassName" value="${jdbc.driverClassName}"/>
          <property name="url" value="${jdbc.url}"/>
          <property name="username" value="${jdbc.username}"/>
          <property name="password" value="${jdbc.password}"/>
      </bean>
  
      <context:property-placeholder location="jdbc.properties"/>
  
  </beans>
  ```

### 3.3.2 Using `NamedParameterJdbcTemplate`

`NamedParameterJdbcTemplate` í´ë˜ìŠ¤ëŠ” JDBC êµ¬ë¬¸ì— ëª…ëª…ëœ ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•´ ì¤€ë‹¤.

ê¸°ì¡´ JDBCêµ¬ë¬¸ê³¼ ë‹¤ë¥¸ ì ì€ `?`ë§Œì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì •ì˜í•œ ë§¤ê°œë³€ìˆ˜ëª…ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.

ì´ í´ë˜ìŠ¤ëŠ” `JdbcTemplate`ë¥¼ í¬í•¨í•œë‹¤.

ëª…ëª…ëœ ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ JDBCêµ¬ë¬¸ì„ í”„ë¡œê·¸ë˜ë°í•  ë•Œ ì´ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```java
// some JDBC-backed DAO class...
private NamedParameterJdbcTemplate namedParameterJdbcTemplate;

public void setDataSource(DataSource dataSource) {
    this.namedParameterJdbcTemplate = new NamedParameterJdbcTemplate(dataSource);
}

public int countOfActorsByFirstName(String firstName) {

    String sql = "select count(*) from T_ACTOR where first_name = :first_name";

    SqlParameterSource namedParameters = new MapSqlParameterSource("first_name", firstName);

    return this.namedParameterJdbcTemplate.queryForObject(sql, namedParameters, Integer.class);
}
```

ë˜ëŠ” ì•„ë˜ì™€ ê°™ì´, `Map` ê¸°ë°˜ìœ¼ë¡œ ëª…ëª…ëœ ë§¤ê°œë³€ìˆ˜ì™€ ê·¸ì— ìƒì‘í•˜ëŠ” ê°’ì„ ì „ë‹¬í•  ìˆ˜ ìˆë‹¤.

```java
// some JDBC-backed DAO class...
private NamedParameterJdbcTemplate namedParameterJdbcTemplate;

public void setDataSource(DataSource dataSource) {
    this.namedParameterJdbcTemplate = new NamedParameterJdbcTemplate(dataSource);
}

public int countOfActorsByFirstName(String firstName) {

    String sql = "select count(*) from T_ACTOR where first_name = :first_name";

    Map<String, String> namedParameters = Collections.singletonMap("first_name", firstName);

    return this.namedParameterJdbcTemplate.queryForObject(sql, namedParameters,  Integer.class);
}
```

`NamedParameterJdbcTemplate`ì—ëŠ” `SqlParameterSource`ì¸í„°í˜ì´ìŠ¤ê°€ ì¡´ì¬í•œë‹¤.

- `SqlParameterSource` :  `NamedParameterJdbcTemplate`ì˜ ëª…ëª…ëœ ë§¤ê°œë³€ìˆ˜ì˜ sourceì´ë‹¤.

- `MapSqlParameterSource`í´ë˜ìŠ¤ :  `java.util.Map`ì˜ ì–´ëŒ‘í„°(í‚¤ê°€ ë§¤ê°œë³€ìˆ˜ ì´ë¦„ì´ê³ , ê°’ì´ ë§¤ê°œë³€ìˆ˜ ê°’)ì¸ ê°„ë‹¨í•œ êµ¬í˜„ì²´ì´ë‹¤.

- `BeanPropertySqlParameterSource`í´ë˜ìŠ¤ : ì„ì˜ì˜ ìë°”ë¹ˆì„ ë©í•‘í•˜ê³ , ë©í•‘ëœ ìë°”ë¹ˆì˜ ì†ì„±ì„ ëª…ëª…ëœ ë§¤ê°œë³€ìˆ˜ì˜ ê°’ì˜ sourceë¡œ ì‚¬ìš©í•¨

- ì˜ˆì‹œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

  - ```java
    public class Actor {
    
        private Long id;
        private String firstName;
        private String lastName;
    
        public String getFirstName() {
            return this.firstName;
        }
    
        public String getLastName() {
            return this.lastName;
        }
    
        public Long getId() {
            return this.id;
        }
    
        // setters omitted...
    
    }
    ```

  - ```java
    // some JDBC-backed DAO class...
    private NamedParameterJdbcTemplate namedParameterJdbcTemplate;
    
    public void setDataSource(DataSource dataSource) {
        this.namedParameterJdbcTemplate = new NamedParameterJdbcTemplate(dataSource);
    }
    
    public int countOfActors(Actor exampleActor) {
    
        // notice how the named parameters match the properties of the above 'Actor' class
        String sql = "select count(*) from T_ACTOR where first_name = :firstName and last_name = :lastName";
    
        SqlParameterSource namedParameters = new BeanPropertySqlParameterSource(exampleActor);
    
        return this.namedParameterJdbcTemplate.queryForObject(sql, namedParameters, Integer.class);
    }
    ```

### 3.3.4 Running Statements

```java
import javax.sql.DataSource;
import org.springframework.jdbc.core.JdbcTemplate;

public class ExecuteAStatement {

    private JdbcTemplate jdbcTemplate;

    public void setDataSource(DataSource dataSource) {
        this.jdbcTemplate = new JdbcTemplate(dataSource);
    }

    public void doExecute() {
        this.jdbcTemplate.execute("create table mytable (id integer, name varchar(100))");
    }
}
```

### 3.3.5 Running Queries

- `queryForObject()` : í•˜ë‚˜ì˜ ê°’ì„ ë¦¬í„´í•  ë•Œ (ê°¯ìˆ˜ë¥¼ ì„¸ê±°ë‚˜, í•œ í–‰ì˜ ê°’ì„ ê²€ìƒ‰ )

  - ë§¤ê°œë³€ìˆ˜ë¡œ `int`ë‚˜ `String`ì„ ë„£ì„ ìˆ˜ ìˆë‹¤

  - ```java
    import javax.sql.DataSource;
    import org.springframework.jdbc.core.JdbcTemplate;
    
    public class RunAQuery {
    
        private JdbcTemplate jdbcTemplate;
    
        public void setDataSource(DataSource dataSource) {
            this.jdbcTemplate = new JdbcTemplate(dataSource);
        }
    
        public int getCount() {
            return this.jdbcTemplate.queryForObject("select count(*) from mytable", Integer.class);
        }
    
        public String getName() {
            return this.jdbcTemplate.queryForObject("select name from mytable", String.class);
        }
    }
    ```

- `queryForList()` : ì—¬ëŸ¬ í•­ëª©ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë¦¬í„´í•  ë•Œ

  - ```java
    private JdbcTemplate jdbcTemplate;
    
    public void setDataSource(DataSource dataSource) {
        this.jdbcTemplate = new JdbcTemplate(dataSource);
    }
    
    public List<Map<String, Object>> getList() {
        return this.jdbcTemplate.queryForList("select * from mytable");
    }
    ```

  - ë¦¬í„´ë˜ëŠ” ë¦¬ìŠ¤íŠ¸ì˜ í˜•íƒœëŠ” `[{name=Bob, id=1}, {name=Mary, id=2}]` ì™€ ê°™ë‹¤.

### 3.3.5. Updating the Database

- íŠ¹ì • PKì˜ ì»¬ëŸ¼ì„ ìˆ˜ì •í•˜ëŠ” ê²½ìš°ì˜ ì˜ˆì‹œ.

  - ```java
    import javax.sql.DataSource;
    import org.springframework.jdbc.core.JdbcTemplate;
    
    public class ExecuteAnUpdate {
    
        private JdbcTemplate jdbcTemplate;
    
        public void setDataSource(DataSource dataSource) {
            this.jdbcTemplate = new JdbcTemplate(dataSource);
        }
    
        public void setName(int id, String name) {
            this.jdbcTemplate.update("update mytable set name = ? where id = ?", name, id);
        }
    }
    ```





